<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head lang="en" th:replace="base/header :: head">
        <title>Hanger</title>
    </head>
    <body>
        <th:block th:include="base/header :: navbar"></th:block>
        <div class="container-fluid main-content">
            <table>
                <tr>
                    <th>
                        <h3 class="page-title">Queries</h3>
                    </th>
                    <th class="btn-action"> 
                        <a th:href="@{'/workbench/workbench/'}" title="Workbench">
                            <span class="glyphicon glyphicon-chevron-right"></span>
                        </a>
                    </th>
                </tr>            
            </table>

            <div th:if="${ errorMessage != null }" class="form-group">
                <div class="alert alert-danger" role="alert">
                    <span th:text="${errorMessage}"></span>
                </div>  
            </div>

            <fieldset>
                <legend class="space-top">Mine</legend>

                <table id="query_stored_my_queries" class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width:3%">#</th>
                            <th style="width:10%">Name</th>
                            <th style="width:30%">Query</th>
                            <th style="width:29%">Connection</th>
                            <th style="width:5%">
                                <span class="glyphicon glyphicon-share-alt"
                                      title="Shared"></span>
                            </th>
                            <th style="width:1%" class="no-sort"></th>
                            <th style="width:1%" class="no-sort"></th>
                            <th style="width:1%" class="no-sort"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="connectionQueryStore : ${connectionQueryStoreList}">
                            <td th:text="${connectionQueryStore.id}">#</td>
                            <td th:text="${connectionQueryStore.name}">#</td>
                            <td>                                
                                <span th:text="${#strings.length(connectionQueryStore.query) > 70 ? #strings.substring(connectionQueryStore.query,0,70) : connectionQueryStore.query}"></span>                                
                                <div class="btn-group" th:if="${#strings.length(connectionQueryStore.query) > 70}">
                                    <button class="dropdown-toggle close" data-toggle="dropdown">...</button>
                                    <ul class="dropdown-menu">                                                
                                        <li>
                                            <pre class="line-numbers">
                                                <code class="language-sql" th:text="${connectionQueryStore.query}"></code>
                                            </pre>
                                        </li>  
                                    </ul>                                    
                                </div>
                            </td>
                            <td th:text="${connectionQueryStore.connection.name}">#</td>
                            <td>                               
                                <div th:if="${connectionQueryStore.shared}">
                                    <span class="glyphicon glyphicon-share-alt"></span>
                                </div>
                            </td> 
                            <td>
                                <a 
                                    th:href="@{'/workbench/workbench/' + ${connectionQueryStore.id}}" 
                                    class="btn btn-generic btn-xs"  
                                    title="Open query">
                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                    Open
                                </a>                                
                            </td>
                            <td>
                                <button 
                                    type="button" 
                                    class="btn btn-generic btn-xs" 
                                    th:id="'edit_' + ${connectionQueryStore.id}" 
                                    th:value="${connectionQueryStore.id}">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> 
                                    Edit
                                </button>
                            </td>
                            <td>
                                <a class="btn btn-xs btn-delete" 
                                   data-toggle="modal" 
                                   th:attr="data-target='#'+${connectionQueryStore.id}" 
                                   href="">
                                    <span 
                                        class="glyphicon glyphicon-trash" 
                                        aria-hidden="true"></span> 
                                    Delete
                                </a>

                                <!-- INÍCIO MODAL DELETE -->
                                <div class="modal fade" 
                                     th:id="${connectionQueryStore.id}" 
                                     tabindex="-1" role="dialog" 
                                     aria-labelledby="modalDelete">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" 
                                                        class="close" 
                                                        data-dismiss="modal" 
                                                        aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                <h4 class="modal-title" 
                                                    id="modalParentLabel">Delete</h4>
                                            </div>
                                            <div class="modal-body">
                                                <span th:inline="text">Are you sure you want to delete [[${connectionQueryStore.name}]]?</span>
                                            </div>
                                            <div class="modal-footer"> 
                                                <a th:href="@{'/query/delete/' + ${connectionQueryStore.id}}" 
                                                   class="col-xs-5 col-sm-5 col-md-5 btn btn-default btn-sm">
                                                    Yes
                                                </a>
                                                <a class="col-xs-5 col-sm-5 col-md-5 btn btn-default btn-sm" 
                                                   data-dismiss="modal" 
                                                   aria-label="Close">
                                                    No
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- FIM MODAL DELETE -->
                            </td>                            
                        </tr>
                    </tbody>
                </table>
            </fieldset>

            <fieldset>
                <legend class="space-top">Shared</legend>

                <table id="query_stored_shared_queries" 
                       class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width:3%">#</th>
                            <th style="width:10%">Name</th>
                            <th style="width:30%">Query</th>
                            <th style="width:25%">Connection</th>
                            <th style="width:15%">Owner</th>
                            <th style="width:1%" class="no-sort"></th>
                        </tr>                        
                    </thead>
                    <tbody>
                        <tr th:each="connectionQueryStore : ${connectionQueryStoreSharedList}">
                            <td th:text="${connectionQueryStore.id}">#</td>
                            <td th:text="${connectionQueryStore.name}">#</td>
                            <td>
                                <span th:text="${#strings.length(connectionQueryStore.query) > 70 ? #strings.substring(connectionQueryStore.query,0,70) : connectionQueryStore.query}"></span>                                
                                <div class="btn-group" th:if="${#strings.length(connectionQueryStore.query) > 70}">
                                    <button class="dropdown-toggle close" data-toggle="dropdown">...</button>
                                    <ul class="dropdown-menu">                                                
                                        <li>
                                            <pre class="line-numbers">
                                                    <code class="language-sql" th:text="${connectionQueryStore.query}"></code>
                                            </pre>
                                        </li>  
                                    </ul>
                                </div>
                            </td>
                            <td th:text="${connectionQueryStore.connection.name}">#</td>
                            <td th:text="${connectionQueryStore.user.username}">#</td>    
                            <td>
                                <a 
                                    th:href="@{'/workbench/workbench/' + ${connectionQueryStore.id}}" 
                                    class="btn btn-generic btn-xs"  
                                    title="Open query">
                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                    Open
                                </a>                                
                            </td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>

            <!--AJAX Parent modal --> 
            <div id="modalHolder"/>

            <center>
                <button id="modal_wait" type="button" class="btn btn-default btn-sm" style="display:none;">
                    <img th:src="@{'/images/ajax-loader.gif'}"></img>
                </button>
            </center>
        </div>
        <script th:inline="javascript">
            $(document).ready(function () {

                $("[id^=edit_]").click(function () {
                    var url = /*[[@{/query/load/modal/}]]*/ "/query/load/modal/";
                    var query = $(this).val();

                    $.ajax({
                        type: "GET",
                        url: url + query,
                        contentType: "text/html",
                        timeout: 1000000,
                        success: function (result) {
                            $("#modalHolder").html(result);
                            $("#modalQueryStore").modal({
                                backdrop: 'static'
                            });
                        },
                        error: function (e) {
                            alert("Fail loading query resultset: "
                                    + e.statusText);
                        }
                    });
                });              
            });
        </script>
    </body>
</html> 